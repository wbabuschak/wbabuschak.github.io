<!DOCTYPE html>
<html>
<body>
    <title>EPIC RPG FIGHT GAME v0.0.3</title>
    <h1>EPIC RPG FIGHT GAME v0.0.3</h1>
    <p>By William Babuschak</p>

    <button id="attackButton">Attack!</button>
    <p></p>
    <button id="autoButton">RSI Mode</button>
    <select id="worldSelect"></select>
    <button id="resetButton">Reset Save Data</button>
        
    <p id="worldTimer"></p>
    <button id="equipButton">Equip Item</button>
    <select id="equipSelect"></select>
    <p></p>
    <button id="unequipButton">Unquip Item</button>
    <select id="unequipSelect"></select>
    
    <p id = "entityDisplay"></p>
    <p id = "dpsDisplay"></p>
    <p id = "equippedItems"></p>
    <p id = "inventory"></p>
    
    
    <script src="entity.js"></script>
    <script src="item.js"></script>
    <script src="loot_table.js"></script>
    <script src="inventory.js"></script>
    <script src="loot_tables.js"></script>
    <script src="enemies.js"></script>

    <style>
        #entityDisplay {
            font-size: 24px;
        }
        #attackButton {
            font-size: 36px;
            padding: 12px 24px;
        }
        #resetButton {
            position: absolute;
            top: 0;
            right: 0;
        }
    </style>

    <script>
        let activeEntity;
        let inventory = new Inventory;
        let equipped = [];
        let autoMode = false;
        let autoInterval;
        let attackCount = 0;
        let lastHits = [];

        function updateInventory(){
            const inventoryElement = document.getElementById("inventory");
            if (inventory.items.length == 0) {
                inventoryElement.textContent = "Inventory is empty.";
            } else {
                inventoryElement.innerHTML = inventory.list();
            }
            updateEquipSelect();
            updateUnequipSelect();
            updateWorldSelect();
        }
        function updateEquipped(){
            const equippedElement = document.getElementById("equippedItems");
            if (!equipped.length) {
                equippedElement.textContent = "No items equipped.";
            } else {
                equippedElement.innerHTML = equipped.map(item => item.name + " (" + item.desc +")").join("<br>");
            }
        }

        function updateEquipSelect() {
            const select = document.getElementById("equipSelect");
            const previousValue = select.value;

            select.innerHTML = "";

            const equippables = inventory.items.filter(item => item.equippable).sort((a, b) => a.equippable.localeCompare(b.equippable));
            for (const item of equippables) {
                let option = document.createElement("option");
                option.value = item.name;
                option.text = `${item.equippable} - ${item.name} (${item.quantity})`;
                select.add(option);
            }

            if (previousValue && Array.from(select.options).some(opt => opt.value === previousValue)) {
                select.value = previousValue;
            } else if (select.options.length > 0 && !select.value) {
                select.selectedIndex = 0;
            }
        }

        function updateWorldSelect(){
            const select = document.getElementById("worldSelect");
            const previousValue = select.value;

            select.innerHTML = "";

            let worlds = [];
            // default world
            worlds.push(0);

            // default world part 2
            let dirtyShoes = inventory.items.find(i => i.name == "Dirty Shoes");
            if (dirtyShoes && (dirtyShoes.quantity >= 10 || (dirtyShoes.quantity >= 9 && itemEquipped("Dirty Shoes")))){
                worlds.push(7);
            }

            // spirit world
            if (itemEquipped("Spectral Cowl") || itemEquipped("Frozen Gemstone Amulet")){
                worlds.push(1);
            }
            // desert world
            let goldCoins = inventory.items.find(i => i.name == "Gold Coin");
            if (goldCoins && goldCoins.quantity >= 500){
                worlds.push(2);
            }

            let hellItem1 = inventory.items.find(i => i.name == "Token of Faith");
            let hellItem2 = inventory.items.find(i => i.name == "Water Jar");
            let hellItem3 = inventory.items.find(i => i.name == "Venomous Gland");
            let hellItem4 = inventory.items.find(i => i.name == "Drained Essence");

            if (hellItem1 && hellItem2 && hellItem3 && hellItem4){
                worlds.push(3);
            }

            let mountainItem1 = inventory.items.find(i => i.name == "Memento of the Vulture");
            let mountainItem2 = inventory.items.find(i => i.name == "Memento of the Dino");
            let mountainItem3 = inventory.items.find(i => i.name == "Memento of the Fangtooth");
            let mountainItem4 = inventory.items.find(i => i.name == "Memento of the Succubus");
            let mountainItem5 = inventory.items.find(i => i.name == "Memento of the Insect");
            let mountainItem6 = inventory.items.find(i => i.name == "Memento of the Bovine");

            let hasPromiseRing = itemEquipped("Promise Ring") || inventory.items.find(i => i.name == "Promise Ring");

            if (mountainItem1 && mountainItem2 && mountainItem3 && mountainItem4 && mountainItem5 && mountainItem6 && hasPromiseRing){
                worlds.push(4);
            }

            if (goldCoins && goldCoins.quantity >= 10000){
                worlds.push(5);
            }

            let platinumCoins = inventory.items.find(i => i.name == "Platinum Coin");
            if (platinumCoins){
                worlds.push(6);
            }

            // magic world
            let firstSeal = inventory.items.find(i => i.name == "First Seal");
            let secondSeal = inventory.items.find(i => i.name == "Second Seal");
            if (firstSeal && secondSeal){
                worlds.push(8);
            }

            // magic world part 2
            let thirdSeal = inventory.items.find(i => i.name == "Third Seal");
            let fourthSeal = inventory.items.find(i => i.name == "Fourth Seal");
            let fifthSeal = inventory.items.find(i => i.name == "Fifth Seal");
            let sixthSeal = inventory.items.find(i => i.name == "Sixth Seal");
            let seventhSeal = inventory.items.find(i => i.name == "Seventh Seal");
            if (thirdSeal && fourthSeal && fifthSeal && sixthSeal && seventhSeal){
                worlds.push(9);
            }

            // space world
            let starJars = inventory.items.find(i => i.name == "Arcane Star Jar");
            if (thirdSeal && starJars.quantity >= 10){
                worlds.push(10);
            }

            for (const world of worlds) {
                let option = document.createElement("option");
                option.value = world;
                option.text = worldName(world);
                select.add(option);
            }

            if (previousValue && Array.from(select.options).some(opt => opt.value === previousValue)) {
                select.value = previousValue;
            } else if (select.options.length > 0 && !select.value) {
                select.selectedIndex = 0;
            }
        
        }

        function updateUnequipSelect() {
            const select = document.getElementById("unequipSelect");
            const previousValue = select.value;

            select.innerHTML = "";

            for (const item of equipped) {
                let option = document.createElement("option");
                option.value = item.name;
                option.text = item.equippable + " - " + item.name;
                select.add(option);
            }

            if (previousValue && Array.from(select.options).some(opt => opt.value === previousValue)) {
                select.value = previousValue;
            } else if (select.options.length > 0 && !select.value) {
                select.selectedIndex = 0;
            }
        }

        function addToLastHits(damage){
            lastHits.push(damage);
            if (lastHits.length > 40){
                lastHits.shift();
            }
        }

        function updateEntityDisplay(lastHit){
            document.getElementById("entityDisplay").innerHTML = lastHit == -1 ? activeEntity.name + "<br>" + activeEntity.HP : activeEntity.name + "<br>" + activeEntity.HP + " (-" + lastHit + ")";
            if (lastHit > -1) addToLastHits(lastHit);
            if (lastHits.length == 0){
                document.getElementById("dpsDisplay").innerHTML = "0 average dmg"
            }
            let cumDamage = 0;
            
            for (let i = 0; i < lastHits.length; i++){
                cumDamage += lastHits[i];
            }
            
            document.getElementById("dpsDisplay").innerHTML = Math.floor(cumDamage / lastHits.length) + " average dmg";
        }

        function equip(itemName){
            // console.log("trying to equip " + itemName);
            if (!inventory.items){
                return;
            }
            let item = inventory.items.find(i => i.name == itemName);
            if (!item){
                return;
            }
            if (!item.equippable){
                return;
            }

            for (let i of equipped){
                if (i.equippable == item.equippable){
                    inventory.addItem(new Item(i.name, 1, i.equippable, i.desc, i.color));
                    equipped = equipped.filter(e => e !== i);
                }
            }

            item.quantity -= 1;
            if(item.quantity == 0) inventory.items = inventory.items.filter(i => i.name !== itemName);

            equipped.push(new Item(item.name, 1, item.equippable, item.desc, item.color));
            // console.log("equipped " + itemName);
            updateInventory();
            updateEquipped();
            updateWorldSelect();
        }

        function itemEquipped(name){
            for (let i of equipped){
                if (i.name == name){
                    return true;
                }
            }
            return false;
        }

        function unequip(itemName){
            let item = equipped.find(i => i.name == itemName);
            if (!item){
                return;
            }
            equipped = equipped.filter(i => i != item);
            inventory.addItem(new Item(item.name, 1, item.equippable, item.desc, item.color));
            updateInventory();
            updateEquipped();
            updateWorldSelect();
        }

        function worldName(i){
            worlds = ["Default World", "Spirit World", "Desert World", "Hell World", "Ice World", "Dragon Swamp World", "Gold World", "Default World (Part 2)", "Magic World", "Space World"];
            return worlds[i];
        }

        function saveGame() {
            const saveData = {
                items: inventory.serialize(),
                equipped: equipped,
            };
            localStorage.setItem("gameSave", JSON.stringify(saveData));
        }

        function loadGame() {
            const savedDataString = localStorage.getItem("gameSave");
            if (savedDataString) {
                const savedData = JSON.parse(savedDataString);

                equipped = savedData.equipped || [];
                autoMode = false;

                inventory = new Inventory();
                inventory.load(savedData.items || []);
            } else {
                inventory = new Inventory();
            }
            updateInventory();
            updateEquipped();
            updateWorldSelect();
        }

        let worldTimer = 0;
        setInterval(() => {
            worldTimer++;
            let alert_message = `You have been in ${worldName(worldSelect.value)} for ${worldTimer} seconds`;
            document.getElementById("worldTimer").textContent = alert_message;
        }, 1000);

        document.getElementById("worldTimer").textContent = "You have been in Default World for 1 seconds";
        worldSelect.addEventListener("change", () => worldTimer = 0);

        window.onload = loadGame;
        window.onbeforeunload = saveGame;

        loadGame();
        updateInventory();
        updateEquipped();
        updateWorldSelect();
    </script>

    <script>
        function hit(){
            let hit = attackDamage();
            activeEntity.damage(hit, inventory);
            attackCount++;
            if (activeEntity.destroyed){
                activeEntity = randomEnemy(Number(worldSelect.value));
                updateInventory();
            } 
            updateEntityDisplay(hit);
        }
        // attack button logic
        document.getElementById("attackButton").addEventListener("click", () => {
            hit();
        });
    </script>

    <script>
        document.getElementById("equipButton").addEventListener("click", () => {
            this.equip(document.getElementById("equipSelect").value);
        });
        document.getElementById("unequipButton").addEventListener("click", () => {
            this.unequip(document.getElementById("unequipSelect").value);
        });
        document.getElementById("resetButton").addEventListener("click", () => {
            inventory = new Inventory();
            equipped = [];
            autoMode = false;
            updateWorldSelect();
            activeEntity = randomEnemy(Number(worldSelect.value));
            updateEntityDisplay(-1);
            saveGame();
            loadGame();
        });
        // document.getElementById("saveButton").addEventListener("click", () => {
        //     saveGame();
        // });
    </script>

    <script>
        function attackDamage(){
            let dmg = 1;
            let dmg_mult = 1.0;
            let set_base = -1;
            let more_mult = 1.0;
            let miss_chance = 0.0;
            let arcane_count = 0;
            let arcane_setbonus = 0;
            let miss_mult = 0;
            for (let i of equipped){
                if (i.name == "Common Dagger") dmg += 3;
                if (i.name == "Ring of Slaying") dmg += 1;
                if (i.name == "Epic Sword") dmg += 7;
                if (i.name == "Fearsome Kris") dmg += 8;
                if (i.name == "Mummy Wraps") dmg_mult += 0.10;
                if (i.name == "Havoc Blade"){
                    dmg_mult += 0.30;
                    dmg += 3;
                };
                if (i.name == "Haunting Guise"){
                    if (!itemInSlot("weapon")){
                        dmg_mult += 0.50;
                    }
                };
                if (i.name == "Ring of Venom") dmg_mult += 0.10;
                if (i.name == "Stormstrike"){
                    if (Math.random() > .5){
                        dmg_mult += 1.00;
                    } else {
                         dmg_mult -= 1.00;
                    }
                };
                if (i.name == "Gauntlets of Sheer Force") set_base = 10;
                if (i.name == "Emesis Amulet"){
                    miss_chance += 0.09;
                    dmg_mult += 0.09;
                    dmg += 9;
                }
                if (i.name == "Crown of the Corpseeater") dmg_mult += 0.11;
                if (i.name == "Wraps of Temptation"){
                    dmg_mult += 0.23;
                    miss_chance += .10;
                }
                if (i.name == "Blade of One Thousand Hooks") dmg_mult += 0.66;
                if (i.name == "Stone of James") more_mult += 0.10;
                if (i.name == "Treads of Crushing Depths") dmg_mult += 0.09;
                if (i.name == "Fossil Blade") dmg += 20;
                if (i.name == "Tooth Necklace") dmg += 6;
                if (i.name == "Killer Gloves") dmg_mult += 0.03;
                if (i.name == "Blasting Wand") dmg += 10;
                if (i.name == "Ice Bear Fur Shawl") dmg += 10;
                if (i.name == "Terror Mask") miss_chance -= 0.20;
                if (i.name == "Dread Loop"){
                    set_base = 16;
                    miss_chance += 0.16;
                }
                if (i.name == "Mote of Arcane Power"){
                    miss_chance -= 0.40;
                    dmg_mult -= 0.20;
                }
                if (i.name == "Nature's Wrath"){
                    dmg += 18;
                    miss_chance -= 0.09;
                    dmg_mult -+ 0.06;
                }
                if (i.name == "Ice Bear Paw Mitts") dmg += 6;
                if (i.name == "Frozen Gemstone Amulet") dmg += 6;
                if (i.name == "Baby Dragon Fang") dmg_mult += 0.13;
                if (i.name == "Juvenile Dragon Talon") dmg += 33;
                if (i.name == "Green Dragonscale Cape") dmg_mult += 0.07;
                if (i.name == "Black Dragonscale Cape"){
                    more_mult += 0.10;
                    miss_chance += 0.07;
                }
                if (i.name == "Blue Dragonscale Cape") dmg += 7;
                if (i.name == "Red Dragonscale Cape"){
                    if (attackCount % 7 == 0) dmg_mult += 1.00;
                }
                if (i.name == "Dragon Mucus Tincture"){
                    if (attackCount % 7 == 0) dmg_mult += 0.10;
                }
                if (i.name == "Dragonheart Piercer"){
                    dmg_mult += 0.07;
                    dmg += 26;
                }
                if (i.name == "Devastating Crossbow"){
                    miss_chance -= 10000.0;
                    dmg += 21;
                }
                if (i.name == "Snake-eye Chain") dmg += 2;
                if (i.name == "Headcracker Mitts") dmg += 1 + Math.floor(Math.random() * 12);
                if (i.name == "Ring of Greed"){
                    dmg_mult += 0.40;
                    if (attackCount % 4 == 0) miss_chance += 1000.0;
                }
                if (i.name == "Goblin Ledger") dmg_mult += 0.01 * (attackCount % 12);
                if (i.name == "Skullstompers") dmg += 1;
                if (i.name == "Devious Dagger"){
                    dmg += 6;
                    dmg_mult += 0.16;
                };
                if (i.name == "Ratkickers") dmg_mult += .06;
                if (i.name == "Gold Cloak"){
                    dmg += 1;
                    dmg_mult += 0.01;
                    more_mult += 0.01;
                    miss_chance -= 0.01;
                };
                if (i.name == "Helmet of Arcane Protection"){
                    dmg += 7;
                    arcane_count++;
                    arcane_setbonus++;
                }
                if (i.name == "Vest of Arcane Devotion"){
                    dmg += 7;
                    arcane_count++;
                    arcane_setbonus++;
                }
                if (i.name == "Gauntlets of Arcane Postmultiplication"){
                    dmg += 7;
                    arcane_count++;
                    arcane_setbonus++;
                }
                if (i.name == "Treads of Arcane Stabilization"){
                    dmg += 7;
                    arcane_count++;
                    arcane_setbonus++;
                }
                if (i.name == "Staff of Arcane Domination"){
                    dmg += 7;
                    arcane_count++;
                    arcane_setbonus++;
                }
                if (i.name == "Arcane Phylactery"){
                    dmg_mult += 0.18;
                    miss_chance += 0.10;
                    arcane_count++;
                }
                if (i.name == "Arcane Shield"){
                    dmg_mult += 0.05;
                    miss_chance -= 0.10;
                    arcane_count++;
                }
                if (i.name == "Arcane Iris"){
                    dmg_mult -= 0.10;
                    miss_mult = 0.5;
                    arcane_count++;
                }
                if (i.name == "Arcane Circuitboard"){
                    if (attackCount % 3 == 0) dmg_mult += 0.08;
                    arcane_count++;
                }
                if (i.name == "Arcane Focusing Gem"){
                    more_mult += 0.13;
                    arcane_count++;
                }
                if (i.name == "Astral Hammer"){
                    dmg += 100;
                    miss_chance += 0.50;
                }
                if (i.name == "Moon Blasting Super Smashers") set_base = 40;
                if (i.name == "Laser Gigawatt Charger"){
                    if (itemEquipped("Astral Hammer") || itemEquipped("Laser-powered Goblin Smasher") || itemEquipped("Green Laser Blaster") || itemEquipped("Grey Laser Blaster")){
                        dmg_mult += 0.30;
                    }
                }
                if (i.name == "Laser-powered Goblin Smasher"){
                    dmg += 22;
                    if (attackCount % 3 == 0){
                        more_mult += 1.00;
                    }
                }
                if (i.name == "Green Laser Blaster") dmg += 55;
                if (i.name == "Grey Laster Blaster"){
                    dmg += 50;
                    dmg_mult += 0.10;
                }
                if (i.name == "Nebula Gemstone"){
                    if (attackCount % 2 == 0){
                        dmg_mult += 0.50;
                    }
                }
            }
            
            dmg = set_base == -1 ? dmg : set_base;
            dmg_mult += (arcane_count * arcane_setbonus * .03);
            let miss = Math.random() < miss_chance;
            if (miss) dmg *= miss_mult;
            return Math.floor(Math.max(0, dmg) * Math.max(0.0, dmg_mult) * Math.max(0.0, more_mult));
        }

        function itemInSlot(slot){
            for (let item of equipped){
                if (item.equippable == slot){
                    return item;
                }
            }
            return null;
        }
    </script>

    <script>
        function randomEnemy(world){
            let enemies = [];
            let worldColor;
            switch(world){
                case 0:
                    enemies.push(spawnEnemy("Common Thief"));
                    enemies.push(spawnEnemy("Dirty Goblin"));
                    enemies.push(spawnEnemy("Mysterious Villain"));
                    worldColor = "#cdffccff"
                    break;
                case 1:
                    enemies.push(spawnEnemy("Spectral Fiend"));
                    enemies.push(spawnEnemy("Spirit Eater"));
                    enemies.push(spawnEnemy("Ghastly Horror"));
                    worldColor = "#ebcaffff"
                    break;
                case 2:
                    enemies.push(spawnEnemy("Desert Wraith"));
                    enemies.push(spawnEnemy("Bile Spitter"));
                    enemies.push(spawnEnemy("Desert Zealot"));
                    enemies.push(spawnEnemy("Sandstone Golem"));
                    worldColor = "#ffe4aaff"
                    break;
                case 3:
                    enemies.push(spawnEnemy("Blazing Bovine"));
                    enemies.push(spawnEnemy("Infernal Insect"));
                    enemies.push(spawnEnemy("Sinful Succubus"));
                    enemies.push(spawnEnemy("Fiery Fangtooth"));
                    enemies.push(spawnEnemy("Dreadful Dino"));
                    enemies.push(spawnEnemy("Vile Vulture"));
                    worldColor = "#ffceceff"
                    break;
                case 4:
                    enemies.push(spawnEnemy("Iceologer"));
                    enemies.push(spawnEnemy("Spooky Revenant"));
                    enemies.push(spawnEnemy("Ice Bear"));
                    enemies.push(spawnEnemy("Animated Weapon"));
                    enemies.push(spawnEnemy("Foul Necromancer"));
                    worldColor = "#bbf1ffff"
                    break;
                case 5:
                    enemies.push(spawnEnemy("Juvenile Green Drake"));
                    enemies.push(spawnEnemy("Juvenile Red Drake"));
                    enemies.push(spawnEnemy("Juvenile Blue Drake"));
                    enemies.push(spawnEnemy("Juvenile Black Drake"));
                    enemies.push(spawnEnemy("Adolescent Green Drake"));
                    enemies.push(spawnEnemy("Adolescent Red Drake"));
                    enemies.push(spawnEnemy("Adolescent Blue Drake"));
                    enemies.push(spawnEnemy("Adolescent Black Drake"));
                    enemies.push(spawnEnemy("Green Drake"));
                    enemies.push(spawnEnemy("Red Drake"));
                    enemies.push(spawnEnemy("Blue Drake"));
                    enemies.push(spawnEnemy("Black Drake"));
                    enemies.push(spawnEnemy("Giant Anaconda"));
                    enemies.push(spawnEnemy("Vainglorious Dragon Hunter"));
                    worldColor = "#93ffd2ff"
                    break;
                case 6:
                    enemies.push(spawnEnemy("Boss Goblin"));
                    enemies.push(spawnEnemy("Goblin Loanmaster"));
                    enemies.push(spawnEnemy("Goblin Headcracker"));
                    enemies.push(spawnEnemy("Gold Goblin Golem"));
                    worldColor = "#eff8a0ff"
                    break;
                case 7:
                    enemies.push(spawnEnemy("Uncommon Bandit"));
                    enemies.push(spawnEnemy("Filthy Goblin"));
                    enemies.push(spawnEnemy("Overgrown Vole"));
                    enemies.push(spawnEnemy("Mysterious Villain"));
                    worldColor = "#bfffbeff"
                    break;
                case 8:
                    enemies.push(spawnEnemy("Keeper of Seals"));
                    worldColor = "#dbceffff"
                    break;
                case 9:
                    enemies.push(spawnEnemy("Arcane Soul Stitcher"));
                    enemies.push(spawnEnemy("Arcane Knight"));
                    enemies.push(spawnEnemy("Arcane Devotee"));
                    enemies.push(spawnEnemy("Arcane Battlemage"));
                    enemies.push(spawnEnemy("Arcane Golem"));
                    worldColor = "#cdbaffff"
                    break; 
                case 10:
                    enemies.push(spawnEnemy("Green Laser Alien"));
                    enemies.push(spawnEnemy("Grey Laser Alien"));
                    enemies.push(spawnEnemy("Ugly Bug Alien"));
                    enemies.push(spawnEnemy("Superstellar Space Raider"));
                    enemies.push(spawnEnemy("Living Comet"));
                    enemies.push(spawnEnemy("Moon Rock Golem"));
                    worldColor = "#7a748aff"
                    break;
                default:
                    enemies.push(spawnEnemy("Dirty Goblin"));
                    worldColor
            }
            if (itemEquipped("Greedy Goldgrubber Grips")){
                for (let i = 0; i < enemies.length; i++){
                    enemies.push(spawnEnemy("Treasure Goblin"));
                }
            }
            document.body.style.backgroundColor = worldColor;
            return enemies[Math.floor(Math.random() * enemies.length)];
        }
    </script>

    <script>
        activeEntity = randomEnemy(Number(worldSelect.value));
        updateEntityDisplay(-1);
    </script>

    <script>
        document.getElementById("autoButton").addEventListener("click", () => {
            autoMode = !autoMode;
            if (autoMode){
                document.getElementById("attackButton").disabled = true;
                autoInterval = setInterval(() => {
                    hit();
                }, 250);
            } else {
                document.getElementById("attackButton").disabled = false;
                clearInterval(autoInterval);
            }
        });
    </script>

    
    
</body>
</html>