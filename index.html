<!DOCTYPE html>
<html>
<body>
    <title>EPIC RPG FIGHT GAME v0.0.1</title>
    <h1>EPIC RPG FIGHT GAME v0.0.1</h1>
    <p>By William Babuschak</p>
    
    <button id="attackButton">Attack!</button>
    <button id="autoButton">RSI Mode</button>
    <select id="worldSelect"></select>
    <p></p>
    <button id="equipButton">Equip Item</button>
    <select id="equipSelect"></select>
    <p></p>
    <button id="unequipButton">Unquip Item</button>
    <select id="unequipSelect"></select>
    
    <p id = "entityDisplay"></p>
    <p id = "equippedItems"></p>
    <p id = "inventory"></p>
    
    
    <script src="entity.js"></script>
    <script src="item.js"></script>
    <script src="loot_table.js"></script>
    <script src="inventory.js"></script>
    <script src="loot_tables.js"></script>
    <script src="enemies.js"></script>

    <script>
        let activeEntity;
        let inventory = new Inventory;
        let equipped = [];
        let autoMode = false;
        let autoInterval;

        function updateInventory(){
            const inventoryElement = document.getElementById("inventory");
            if (inventory.items.length == 0) {
                inventoryElement.textContent = "Inventory is empty.";
            } else {
                inventoryElement.innerHTML = inventory.list();
            }
            updateEquipSelect();
            updateUnequipSelect();
            updateWorldSelect();
        }
        function updateEquipped(){
            const equippedElement = document.getElementById("equippedItems");
            if (!equipped.length) {
                equippedElement.textContent = "No items equipped.";
            } else {
                equippedElement.innerHTML = equipped.map(item => item.name + " (" + item.desc +")").join("<br>");
            }
        }

        function updateEquipSelect() {
            const select = document.getElementById("equipSelect");
            const previousValue = select.value;

            select.innerHTML = "";

            const equippables = inventory.items.filter(item => item.equippable);
            for (const item of equippables) {
                let option = document.createElement("option");
                option.value = item.name;
                option.text = `${item.name} (${item.quantity})`;
                select.add(option);
            }

            if (previousValue && Array.from(select.options).some(opt => opt.value === previousValue)) {
                select.value = previousValue;
            } else if (select.options.length > 0 && !select.value) {
                select.selectedIndex = 0;
            }
        }

        function updateWorldSelect(){
            const select = document.getElementById("worldSelect");
            const previousValue = select.value;

            select.innerHTML = "";

            let worlds = [];
            // default world
            worlds.push(0);
            // spirit world
            if (itemEquipped("Spectral Cowl")){
                worlds.push(1);
            }
            // desert world
            let goldCoins = inventory.items.find(i => i.name == "Gold Coin");
            if (goldCoins && goldCoins.quantity > 500){
                worlds.push(2);
            }

            let hellItem1 = inventory.items.find(i => i.name == "Token of Faith");
            let hellItem2 = inventory.items.find(i => i.name == "Water Jar");
            let hellItem3 = inventory.items.find(i => i.name == "Venomous Gland");
            let hellItem4 = inventory.items.find(i => i.name == "Drained Essense");

            if (hellItem1 && hellItem2 && hellItem3 && hellItem4){
                worlds.push(3);
            }
            
            for (const world of worlds) {
                let option = document.createElement("option");
                option.value = world;
                option.text = worldName(world);
                select.add(option);
            }

            if (previousValue && Array.from(select.options).some(opt => opt.value === previousValue)) {
                select.value = previousValue;
            } else if (select.options.length > 0 && !select.value) {
                select.selectedIndex = 0;
            }
        
        }

        function updateUnequipSelect() {
            const select = document.getElementById("unequipSelect");
            const previousValue = select.value;

            select.innerHTML = "";

            for (const item of equipped) {
                let option = document.createElement("option");
                option.value = item.name;
                option.text = item.name;
                select.add(option);
            }

            if (previousValue && Array.from(select.options).some(opt => opt.value === previousValue)) {
                select.value = previousValue;
            } else if (select.options.length > 0 && !select.value) {
                select.selectedIndex = 0;
            }
        }

        function updateEntityDisplay(){
            document.getElementById("entityDisplay").innerHTML = activeEntity.name + "<br>" + activeEntity.HP;
        }

        function equip(itemName){
            // console.log("trying to equip " + itemName);
            if (!inventory.items){
                return;
            }
            let item = inventory.items.find(i => i.name == itemName);
            if (!item){
                return;
            }
            if (!item.equippable){
                return;
            }

            for (let i of equipped){
                if (i.equippable == item.equippable){
                    inventory.addItem(new Item(i.name, 1, i.equippable, i.desc));
                    equipped = equipped.filter(e => e !== i);
                }
            }

            item.quantity -= 1;
            if(item.quantity == 0) inventory.items = inventory.items.filter(i => i.name !== itemName);

            equipped.push(new Item(item.name, 1, item.equippable, item.desc));
            // console.log("equipped " + itemName);
            updateInventory();
            updateEquipped();
            updateWorldSelect();
        }

        function itemEquipped(name){
            for (let i of equipped){
                if (i.name == name){
                    return true;
                }
            }
            return false;
        }

        function unequip(itemName){
            let item = equipped.find(i => i.name == itemName);
            if (!item){
                return;
            }
            equipped = equipped.filter(i => i != item);
            inventory.addItem(new Item(item.name, 1, item.equippable, item.desc));
            updateInventory();
            updateEquipped();
            updateWorldSelect();
        }

        function worldName(i){
            worlds = ["Default World", "Spirit World", "Desert World", "Hell World"];
            return worlds[i];
        }

        updateInventory();
        updateEquipped();
        updateWorldSelect();
    </script>

    <script>
        // attack button logic
        document.getElementById("attackButton").addEventListener("click", () => {
            activeEntity.damage(attackDamage(), inventory);
            if (activeEntity.destroyed){
                activeEntity = randomEnemy(Number(worldSelect.value));
                updateInventory();
            } 
            updateEntityDisplay();
        });
    </script>

    <script>
        document.getElementById("equipButton").addEventListener("click", () => {
            this.equip(document.getElementById("equipSelect").value);
        });
        document.getElementById("unequipButton").addEventListener("click", () => {
            this.unequip(document.getElementById("unequipSelect").value);
        });
    </script>

    <script>
        function attackDamage(){
            let dmg = 1;
            let dmg_mult = 1.0;
            let set_base = -1;
            let more_mult = 1.0;
            let miss_chance = 0.0;
            for (let i of equipped){
                if (i.name == "Common Dagger") dmg += 3;
                if (i.name == "Ring of Slaying") dmg += 1;
                if (i.name == "Epic Sword") dmg += 7;
                if (i.name == "Fearsome Kris") dmg += 8;
                if (i.name == "Mummy Wraps") dmg_mult += 0.10;
                if (i.name == "Havoc Blade"){
                    dmg_mult += 0.30;
                    dmg += 3;
                };
                if (i.name == "Haunting Guise"){
                    if (!itemInSlot("weapon")){
                        dmg_mult += 0.50;
                    }
                };
                if (i.name == "Ring of Venom") dmg_mult += 0.10;
                if (i.name == "Stormstrike"){
                    if (Math.random() > .5){
                        dmg_mult += 1.00;
                    } else {
                         dmg_mult -= 1.00;
                    }
                };
                if (i.name == "Gauntlets of Sheer Force") set_base = 10;
                if (i.name == "Emesis Amulet"){
                    miss_chance += 0.06;
                    dmg_mult += 0.06;
                    dmg += 6;
                }
                if (i.name == "Crown of the Corpseeater") dmg_mult += 0.11;
                if (i.name == "Wraps of Temptation"){
                    dmg_mult += 0.23;
                    miss_chance += .10;
                }
                if (i.name == "Blade of One Thousand Hooks") dmg_mult += 0.66;
                if (i.name == "Stone of Michael") more_mult += 0.10;
                if (i.name == "Treads of Crushing Depths") dmg_mult += 0.05;
                if (i.name == "Fossil Blade") dmg += 20;
                if (i.name == "Tooth Necklace") dmg += 6;
                if (i.name == "Killer Gloves") dmg_mult += 0.03;
                if (i.name == "Blasting Wand") dmg += 10;

            }

            dmg = set_base == -1 ? dmg : set_base;
            if (Math.random() < miss_chance){
                return 0;
            }
            return Math.floor(Math.max(0, dmg) * Math.max(0.0, dmg_mult) * Math.max(0.0, more_mult));
        }

        function itemInSlot(slot){
            for (let item of equipped){
                if (item.equippable == slot){
                    return item;
                }
            }
            return null;
        }
    </script>

    <script>
        function randomEnemy(world){
            let enemies = [];
            switch(world){
                case 0:
                    enemies.push(spawnEnemy("Common Thief"));
                    enemies.push(spawnEnemy("Dirty Goblin"));
                    enemies.push(spawnEnemy("Mysterious Villain"));
                    break;
                case 1:
                    enemies.push(spawnEnemy("Spectral Fiend"));
                    enemies.push(spawnEnemy("Spirit Eater"));
                    enemies.push(spawnEnemy("Ghastly Horror"));
                    break;
                case 2:
                    enemies.push(spawnEnemy("Desert Wraith"));
                    enemies.push(spawnEnemy("Bile Spitter"));
                    enemies.push(spawnEnemy("Desert Zealot"));
                    enemies.push(spawnEnemy("Sandstone Golem"));
                    break;
                case 3:
                    enemies.push(spawnEnemy("Blazing Bovine"));
                    enemies.push(spawnEnemy("Infernal Insect"));
                    enemies.push(spawnEnemy("Sinful Succubus"));
                    enemies.push(spawnEnemy("Fiery Fangtooth"));
                    enemies.push(spawnEnemy("Dreadful Dino"));
                    enemies.push(spawnEnemy("Vile Vulture"));
                    break;
                default:
                    enemies.push(spawnEnemy("Dirty Goblin"));
            }
            return enemies[Math.floor(Math.random() * enemies.length)];
        }
    </script>

    <script>
        activeEntity = randomEnemy(Number(worldSelect.value));
        updateEntityDisplay();
    </script>

    <script>
        document.getElementById("autoButton").addEventListener("click", () => {
            autoMode = !autoMode;
            if (autoMode){
                document.getElementById("attackButton").disabled = true;
                autoInterval = setInterval(() => {
                    activeEntity.damage(attackDamage(), inventory);
                    if (activeEntity.destroyed) {
                        activeEntity = randomEnemy(Number(worldSelect.value));
                        updateInventory();
                    }
                    updateEntityDisplay();
                }, 250);
            } else {
                document.getElementById("attackButton").disabled = false;
                clearInterval(autoInterval);
            }
        });
    </script>

    
    
</body>
</html>